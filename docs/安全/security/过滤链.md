Security 关键的过滤器：

DigestAuthenticationFilter  -- 往securityContext里面塞入 token

![image-20201106120219821](过滤链.assets/image-20201106120219821.png)

使用code 和 state 获取access_token的过程： 参考 spring-security-oauth2:2.2.1-REALEASE

在OAuth2RestTemplate.java  --- >  acquireAccessToken 方法 -->  

> ```
> accessToken = accessTokenProvider.obtainAccessToken(resource, accessTokenRequest);
> ```

AccessTokenProvider.java 接口，最后调用实现子类： AuthorizationCodeAccessTokenProvider   --->   L197 

![image-20201106154754315](过滤链.assets/image-20201106154754315.png)

OAuth2AccessTokenSupport.java   -- 请求获取access_token

![image-20201106155106225](过滤链.assets/image-20201106155106225.png)



HttpServletRequestImpl   属于undertow-servlet:1.4.26.jar包  changeSessionId()方法， 会把originalServletContext里面的旧sessionId，替换为新的sessionId

OAuth2ClientAuthenticationProcessingFilter extends AbstractAuthenticationProcessingFilter

AuthenticationHeaderFilter.java  -- 过滤器链排序第9，设置请求头代理忽略 authorization

OAuth2AuthenticationDetails.java -- 过滤链排序第10  从httq request里面获取token，创建了OAuth2AuthenticationDetails 对象

OAuth2TokenRelayFilter  -- 往请求头里面加入token



登陆成功后，临时回话的sessionId会被登陆成功后的sessionId替换



![image-20201106120200079](过滤链.assets/image-20201106120200079.png)











![login-redirect-full-process](过滤链.assets/login-redirect-full-process.png)